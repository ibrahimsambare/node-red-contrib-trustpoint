<script type="text/html" data-template-name="trustpoint-simplereenroll">

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Node name">
    </div>

    <div class="form-row">
        <label for="node-input-estUrl"><i class="fa fa-link"></i> EST URL</label>
        <input type="text" id="node-input-estUrl" placeholder="https://your-server/.well-known/est/reenroll" style="width: 100%;">
        <input type="hidden" id="node-input-estUrl_fieldType">
    </div>

    <div class="form-row">
        <label for="node-input-clientCert"><i class="fa fa-certificate"></i> Client Certificate (PEM)</label>
        <input type="text" id="node-input-clientCert" placeholder="msg.payload.clientCert or inline PEM" style="width: 100%;">
        <input type="hidden" id="node-input-clientCert_fieldType">
    </div>

    <div class="form-row">
        <label for="node-input-clientKey"><i class="fa fa-key"></i> Private Key (PEM)</label>
        <input type="text" id="node-input-clientKey" placeholder="msg.payload.clientKey or inline PEM" style="width: 100%;">
        <input type="hidden" id="node-input-clientKey_fieldType">
    </div>

    <div class="form-row">
        <label for="node-input-rejectUnauthorized"><i class="fa fa-shield"></i> Verify Server Certificate</label>
        <input type="checkbox" id="node-input-rejectUnauthorized" style="vertical-align: middle;">
        <span> Reject untrusted TLS certs</span>
    </div>

    <div id="reenroll-preview" class="validation-result">
        <div class="validation-box validation-info" id="reenroll-preview-box">
            This node requires a CSR buffer in <code>msg.payload.csr</code> and an EST URL. If the URL is not defined in the node, it can be passed via <code>msg.payload.estBaseUrl</code>.
        </div>
    </div>

</script>

<style>
    .validation-box {
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        font-weight: normal;
    }

    .validation-info {
        background-color: #4cafaf;
        color: white;
    }
</style>

<script type="text/javascript">
    (function () {
        RED.nodes.registerType('trustpoint-simplereenroll', {
            category: 'Trustpoint',
            color: '#ccccff',
            defaults: {
                name: { value: "" },
                estUrl: { value: "", required: false },
                estUrl_fieldType: { value: "str" },
                clientCert: { value: "", required: false },
                clientCert_fieldType: { value: "str" },
                clientKey: { value: "", required: false },
                clientKey_fieldType: { value: "str" },
                rejectUnauthorized: { value: true }
            },
            inputs: 1,
            outputs: 1,
            icon: "font-awesome/fa-refresh",
            label: function () {
                return this.name || "trustpoint-simplereenroll";
            },
            labelStyle: function () {
                return this.name ? "node_label_italic" : "";
            },
            oneditprepare: function () {
                $("#node-input-clientCert").typedInput({
                    default: 'str',
                    types: ['str', 'msg', 'flow', 'global'],
                    typeField: $("#node-input-clientCert_fieldType")
                });

                $("#node-input-clientKey").typedInput({
                    default: 'str',
                    types: ['str', 'msg', 'flow', 'global'],
                    typeField: $("#node-input-clientKey_fieldType")
                });

                $("#node-input-estUrl").typedInput({
                    default: 'str',
                    types: ['str', 'msg', 'flow', 'global'],
                    typeField: $("#node-input-estUrl_fieldType")
                });

                $("#reenroll-preview-box").addClass("validation-info");
            }
        });
    })();
</script>
